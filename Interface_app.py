import streamlit as st
import pandas as pd

# --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ---
sheet_url = "https://docs.google.com/spreadsheets/d/1ENpJYa3tnNrv6BBZJFG9pDNUTDqkbP7RQyBnA6pKSLI/edit?usp=sharing"
csv_url = sheet_url.replace("/edit?usp=sharing", "/export?format=csv")

@st.cache_data(ttl=300)
def load_data(url):
    return pd.read_csv(url)

df = load_data(csv_url)

# --- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ default ‡πÉ‡∏ô session_state ---
if "submitted" not in st.session_state:
    st.session_state.submitted = False
if "selected_result" not in st.session_state:
    st.session_state.selected_result = None
if "user_input" not in st.session_state:
    st.session_state.user_input = {}

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ---
def reset_all():
    st.session_state.submitted = False
    st.session_state.selected_result = None
    st.session_state.user_input = {}

# --- UI ‡∏´‡∏•‡∏±‡∏Å ---
st.title("üçΩÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£")

# --- ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
if not st.session_state.submitted:
    with st.form("input_form"):
        st.markdown("### üîç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")

        user_location = st.selectbox("üìç ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", df["location"].dropna().unique())
        all_types = pd.unique(pd.concat([df["type_1"], df["type_2"]]).dropna())
        user_type = st.selectbox("üç± ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£", all_types)
        user_budget = st.selectbox("üí∏ ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì", df["budget"].dropna().unique())
        user_time = st.selectbox("‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ (‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡∏¥‡∏î)", df["time_to_open"].dropna().unique())

        submitted = st.form_submit_button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô")

    if submitted:
        st.session_state.user_input = {
            "location": user_location,
            "type": user_type,
            "budget": user_budget,
            "time_to_open": user_time,
        }
        st.session_state.submitted = True
        st.experimental_rerun()

# --- ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡πÅ‡∏•‡πâ‡∏ß ---
if st.session_state.submitted and not st.session_state.selected_result:
    user_input = st.session_state.user_input

    # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    filtered_df = df[
        ((df["type_1"] == user_input["type"]) | (df["type_2"] == user_input["type"])) &
        (df["location"] == user_input["location"]) &
        (df["budget"] == user_input["budget"]) &
        (df["time_to_open"] == user_input["time_to_open"])
    ]

    if not filtered_df.empty:
        st.subheader("üéØ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì:")

        for i, row in filtered_df.iterrows():
            if st.button(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {row['name']} ({row['type_1']} / {row['type_2']})", key=f"select_{i}"):
                st.session_state.selected_result = row['name']
                st.experimental_rerun()

        st.button("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡∏ï‡∏£‡∏á‡πÉ‡∏à", on_click=lambda: st.session_state.update(selected_result="none"))
    else:
        st.warning("üò• ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
        st.button("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡∏ï‡∏£‡∏á‡πÉ‡∏à", on_click=lambda: st.session_state.update(selected_result="none"))

# --- ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì ---
if st.session_state.selected_result:
    st.success("üôè ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö")
    if st.session_state.selected_result != "none":
        st.write(f"‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô: **{st.session_state.selected_result}**")
    else:
        st.write("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏î‡πÄ‡∏•‡∏¢")

    if st.button("üîÅ ‡∏ó‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"):
        reset_all()
        st.experimental_rerun()
